<!-- æ¯”èµ›è®°å½•å½•å…¥é¡µé¢ - 4èŠ‚åˆ¶åˆ†æ­¥å½•å…¥ -->
<view class="record-container">
  <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
  <view class="progress-bar">
    <view
      class="progress-step {{currentStep >= item.id ? 'active' : ''}}"
      wx:for="{{steps}}"
      wx:key="id"
    >
      <view class="step-circle">{{item.id}}</view>
      <text class="step-name">{{item.name}}</text>
    </view>
  </view>

  <!-- å†…å®¹åŒºåŸŸ -->
  <scroll-view class="content" scroll-y enable-back-to-top>

    <!-- Step 1: åŸºæœ¬ä¿¡æ¯ -->
    <view class="step-content" wx:if="{{currentStep === 1 && matchInfo}}">
      <view class="match-info-card">
        <view class="match-header">
          <text class="match-title">{{matchInfo.title}}</text>
          <text class="match-date">{{matchInfo.date}} {{matchInfo.time}}</text>
          <text class="match-location">ğŸ“ {{matchInfo.location}}</text>
        </view>

        <view class="teams-display">
          <view class="team-item">
            <image class="team-logo-big" src="{{matchInfo.team1.logo}}" mode="aspectFill"></image>
            <text class="team-name-big">{{matchInfo.team1.name}}</text>
          </view>
          <text class="vs-big">VS</text>
          <view class="team-item">
            <image class="team-logo-big" src="{{matchInfo.team2.logo}}" mode="aspectFill"></image>
            <text class="team-name-big">{{matchInfo.team2.name}}</text>
          </view>
        </view>
      </view>

      <view class="info-tip">
        <text class="tip-icon">ğŸ’¡</text>
        <text class="tip-text">æ¥ä¸‹æ¥å°†å¼•å¯¼æ‚¨åˆ†4èŠ‚å½•å…¥æ¯”èµ›æ•°æ®ï¼Œæ¯èŠ‚ç‹¬ç«‹è®°å½•è¿›çƒå’Œäº‹ä»¶</text>
      </view>
    </view>

    <!-- Step 2-5: ç¬¬1-4èŠ‚å½•å…¥ -->
    <view class="step-content" wx:if="{{currentStep >= 2 && currentStep <= 5 && matchInfo}}">
      <quarter-input
        match-id="{{matchId}}"
        quarter-number="{{currentStep - 1}}"
        team1="{{matchInfo.team1}}"
        team2="{{matchInfo.team2}}"
        quarter-data="{{quarters[currentStep - 2]}}"
        all-players="{{allPlayers}}"
        team1-selectable-players="{{team1SelectablePlayers}}"
        team2-selectable-players="{{team2SelectablePlayers}}"
        unassigned-players-group="{{unassignedPlayersGroup}}"
        bind:change="onQuarterChange"
        bind:saved="onQuarterSaved"
      />

      <!-- å½“å‰ç´¯è®¡å¾—åˆ†é¢„è§ˆ -->
      <view class="score-preview-card">
        <view class="preview-header" bindtap="onToggleScorePreview">
          <text class="preview-title">ğŸ“Š å½“å‰ç´¯è®¡å¾—åˆ†</text>
          <text class="preview-toggle">{{showScorePreview ? 'æ”¶èµ·' : 'å±•å¼€'}}</text>
        </view>

        <view class="preview-body" wx:if="{{showScorePreview}}">
          <view class="preview-row">
            <text class="preview-label">ç´¯è®¡å¾—åˆ†</text>
            <text class="preview-value score">{{totalTeam1Score}} : {{totalTeam2Score}}</text>
          </view>
          <view class="preview-row">
            <text class="preview-label">ç´¯è®¡è¿›çƒ</text>
            <text class="preview-value">{{totalTeam1Goals}} : {{totalTeam2Goals}}</text>
          </view>

          <!-- å„èŠ‚å¾—åˆ†æ˜ç»† -->
          <view class="quarters-detail">
            <view
              class="quarter-detail-item"
              wx:for="{{quarters}}"
              wx:key="quarterNumber"
              wx:if="{{item.quarterNumber < currentStep - 1}}"
            >
              <text class="quarter-num">ç¬¬{{item.quarterNumber}}èŠ‚</text>
              <text class="quarter-goals">{{item.team1Goals}}:{{item.team2Goals}}</text>
              <text class="quarter-points">({{item.team1Points}}:{{item.team2Points}}åˆ†)</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- Step 6: ç‚¹çƒå¤§æˆ˜ï¼ˆä»…åœ¨å¹³å±€æ—¶æ˜¾ç¤ºï¼‰ -->
    <view class="step-content" wx:if="{{currentStep === 6 && needPenalty && matchInfo}}">
      <view class="section-card">
        <view class="section-header">
          <text class="section-title">âš½ ç‚¹çƒå¤§æˆ˜</text>
          <text class="section-desc">å¸¸è§„æ—¶é—´æ¯”åˆ†ç›¸åŒï¼Œè¯·å½•å…¥ç‚¹çƒå¤§æˆ˜ç»“æœ</text>
        </view>

        <!-- å¸¸è§„æ—¶é—´æ¯”åˆ†å±•ç¤º -->
        <view class="regular-time-score">
          <text class="regular-label">å¸¸è§„æ—¶é—´</text>
          <view class="score-row">
            <view class="team-score-item">
              <image class="team-logo-medium" src="{{matchInfo.team1.logo}}" mode="aspectFill"></image>
              <text class="team-name-medium">{{matchInfo.team1.name}}</text>
              <text class="score-number">{{totalTeam1Score}}</text>
            </view>
            <text class="vs-text">:</text>
            <view class="team-score-item">
              <image class="team-logo-medium" src="{{matchInfo.team2.logo}}" mode="aspectFill"></image>
              <text class="team-name-medium">{{matchInfo.team2.name}}</text>
              <text class="score-number">{{totalTeam2Score}}</text>
            </view>
          </view>
        </view>

        <!-- ç‚¹çƒæ¯”åˆ†è¾“å…¥ -->
        <view class="penalty-score-input">
          <text class="penalty-label">ç‚¹çƒå¤§æˆ˜æ¯”åˆ†</text>
          <view class="penalty-input-row">
            <!-- é˜Ÿä¼1 -->
            <view class="penalty-team-input">
              <image class="penalty-logo" src="{{matchInfo.team1.logo}}" mode="aspectFill"></image>
              <text class="penalty-team-name">{{matchInfo.team1.name}}</text>
              <input
                class="penalty-score-field"
                type="number"
                value="{{penaltyShootout.team1Score}}"
                bindinput="onPenaltyTeam1Input"
                placeholder="0"
              />
            </view>

            <text class="penalty-vs">:</text>

            <!-- é˜Ÿä¼2 -->
            <view class="penalty-team-input">
              <image class="penalty-logo" src="{{matchInfo.team2.logo}}" mode="aspectFill"></image>
              <text class="penalty-team-name">{{matchInfo.team2.name}}</text>
              <input
                class="penalty-score-field"
                type="number"
                value="{{penaltyShootout.team2Score}}"
                bindinput="onPenaltyTeam2Input"
                placeholder="0"
              />
            </view>
          </view>
        </view>

        <!-- è·èƒœæ–¹æç¤º -->
        <view class="penalty-winner-tip" wx:if="{{penaltyShootout.winner}}">
          <view class="winner-icon">ğŸ†</view>
          <view class="winner-text">
            {{penaltyShootout.winner === 'team1' ? matchInfo.team1.name : matchInfo.team2.name}} ç‚¹çƒè·èƒœ
          </view>
        </view>
      </view>
    </view>

    <!-- Step 6/7: åˆ°åœºäººå‘˜ï¼ˆæ— ç‚¹çƒæ—¶æ­¥éª¤6ï¼Œæœ‰ç‚¹çƒæ—¶æ­¥éª¤7ï¼‰ -->
    <view class="step-content" wx:if="{{((currentStep === 6 && !needPenalty) || (currentStep === 7 && needPenalty)) && matchInfo}}">
      <view class="section-card">
        <view class="section-header">
          <text class="section-title">åˆ°åœºäººå‘˜é€‰æ‹©</text>
          <text class="section-desc">è¯·é€‰æ‹©æœ¬åœºæ¯”èµ›çš„åˆ°åœºçƒå‘˜</text>
        </view>

        <!-- é˜Ÿä¼1åˆ°åœºäººå‘˜ -->
        <view class="participant-team">
          <view class="participant-header">
            <view class="team-info">
              <image class="team-logo-small" src="{{matchInfo.team1.logo}}" mode="aspectFill"></image>
              <text class="team-name">{{matchInfo.team1.name}}</text>
            </view>
            <view class="select-btn" bindtap="onShowParticipantPicker" data-team="team1">
              <text class="select-count">å·²é€‰{{participants.team1.length}}äºº</text>
              <text class="select-arrow">â€º</text>
            </view>
          </view>

          <view class="participant-list" wx:if="{{participants.team1.length > 0}}">
            <view class="participant-item" wx:for="{{participants.team1}}" wx:key="id">
              <image class="participant-avatar" src="{{item.avatar || images.defaultAvatar}}" mode="aspectFill"></image>
              <text class="participant-name">{{item.name || item.nickname}}</text>
              <image class="participant-remove" src="{{icons.closeRed}}" bindtap="onRemoveParticipant" data-team="team1" data-id="{{item.id}}" mode="aspectFill"></image>
            </view>
          </view>
          <view class="participant-empty" wx:else>
            <text>ç‚¹å‡»ä¸Šæ–¹é€‰æ‹©åˆ°åœºäººå‘˜</text>
          </view>
        </view>

        <!-- é˜Ÿä¼2åˆ°åœºäººå‘˜ -->
        <view class="participant-team">
          <view class="participant-header">
            <view class="team-info">
              <image class="team-logo-small" src="{{matchInfo.team2.logo}}" mode="aspectFill"></image>
              <text class="team-name">{{matchInfo.team2.name}}</text>
            </view>
            <view class="select-btn" bindtap="onShowParticipantPicker" data-team="team2">
              <text class="select-count">å·²é€‰{{participants.team2.length}}äºº</text>
              <text class="select-arrow">â€º</text>
            </view>
          </view>

          <view class="participant-list" wx:if="{{participants.team2.length > 0}}">
            <view class="participant-item" wx:for="{{participants.team2}}" wx:key="id">
              <image class="participant-avatar" src="{{item.avatar || images.defaultAvatar}}" mode="aspectFill"></image>
              <text class="participant-name">{{item.name || item.nickname}}</text>
              <image class="participant-remove" src="{{icons.closeRed}}" bindtap="onRemoveParticipant" data-team="team2" data-id="{{item.id}}" mode="aspectFill"></image>
            </view>
          </view>
          <view class="participant-empty" wx:else>
            <text>ç‚¹å‡»ä¸Šæ–¹é€‰æ‹©åˆ°åœºäººå‘˜</text>
          </view>
        </view>
      </view>
    </view>

    <!-- Step 7/8: MVPä¸ç…§ç‰‡ï¼ˆæ— ç‚¹çƒæ—¶æ­¥éª¤7ï¼Œæœ‰ç‚¹çƒæ—¶æ­¥éª¤8ï¼‰ -->
    <view class="step-content" wx:if="{{((currentStep === 7 && !needPenalty) || (currentStep === 8 && needPenalty)) && matchInfo}}">
      <!-- æœ€ç»ˆå¾—åˆ†å±•ç¤º -->
      <view class="final-score-card">
        <text class="final-title">æ¯”èµ›ç»“æœ</text>
        <view class="final-score-display">
          <view class="final-team">
            <image class="final-logo" src="{{matchInfo.team1.logo}}" mode="aspectFill"></image>
            <text class="final-name">{{matchInfo.team1.name}}</text>
            <text class="final-score {{totalTeam1Score > totalTeam2Score ? 'winner' : ''}}">{{totalTeam1Score}}</text>
            <text class="final-goals">({{totalTeam1Goals}}çƒ)</text>
          </view>
          <text class="final-vs">:</text>
          <view class="final-team">
            <image class="final-logo" src="{{matchInfo.team2.logo}}" mode="aspectFill"></image>
            <text class="final-name">{{matchInfo.team2.name}}</text>
            <text class="final-score {{totalTeam2Score > totalTeam1Score ? 'winner' : ''}}">{{totalTeam2Score}}</text>
            <text class="final-goals">({{totalTeam2Goals}}çƒ)</text>
          </view>
        </view>

        <!-- ç‚¹çƒå¤§æˆ˜ç»“æœ -->
        <view class="penalty-result" wx:if="{{penaltyShootout.enabled}}">
          <view class="penalty-label">ç‚¹çƒå¤§æˆ˜</view>
          <view class="penalty-score-display">
            <view class="penalty-team-score {{penaltyShootout.winner === 'team1' ? 'penalty-winner' : ''}}">
              {{penaltyShootout.team1Score}}
            </view>
            <view class="penalty-separator">-</view>
            <view class="penalty-team-score {{penaltyShootout.winner === 'team2' ? 'penalty-winner' : ''}}">
              {{penaltyShootout.team2Score}}
            </view>
          </view>
          <view class="penalty-winner-badge">
            ğŸ† {{penaltyShootout.winner === 'team1' ? matchInfo.team1.name : matchInfo.team2.name}} ç‚¹çƒè·èƒœ
          </view>
        </view>
      </view>

      <!-- MVPé€‰æ‹© -->
      <view class="section-card mvp-section">
        <view class="section-header">
          <text class="section-title">ğŸ† æœ¬åœºMVP</text>
          <text class="section-desc">å¯é€‰æ‹©å¤šäºº</text>
        </view>

        <!-- å·²é€‰æ‹©çš„MVPåˆ—è¡¨ -->
        <view class="mvp-container" wx:if="{{mvpPlayers.length > 0}}">
          <view class="mvp-item" wx:for="{{mvpPlayers}}" wx:key="id">
            <view class="mvp-glow"></view>
            <image class="mvp-avatar-mini" src="{{item.avatar || images.defaultAvatar}}" mode="aspectFill"></image>
            <view class="mvp-details">
              <text class="mvp-name-mini">{{item.name}}</text>
              <text class="mvp-num" wx:if="{{item.nickname}}">{{item.nickname}}</text>
            </view>
            <view class="mvp-trophy-mini">ğŸ†</view>
            <view class="mvp-del" bindtap="onRemoveMvp" data-id="{{item.id}}">Ã—</view>
          </view>

          <!-- æ·»åŠ æŒ‰é’® -->
          <view class="mvp-add-compact" bindtap="onShowMvpPicker">
            <text class="add-plus">+</text>
          </view>
        </view>

        <!-- ç©ºçŠ¶æ€ -->
        <view class="mvp-empty-compact" wx:else bindtap="onShowMvpPicker">
          <text class="empty-trophy">ğŸ†</text>
          <text class="empty-hint">é€‰æ‹©MVP</text>
        </view>
      </view>

      <!-- æ¯”èµ›ç®€æŠ¥ -->
      <view class="section-card summary-section">
        <view class="section-header">
          <text class="section-title">ğŸ“ æ¯”èµ›ç®€æŠ¥</text>
          <text class="section-desc">é€‰å¡«</text>
        </view>

        <view class="summary-input-wrapper">
          <textarea
            class="summary-textarea"
            placeholder="ç²˜è´´æˆ–è¾“å…¥æ¯”èµ›ç®€æŠ¥ï¼ˆå¦‚ï¼šæ¯”åˆ†æƒ…å†µã€ç²¾å½©ç¬é—´ã€æŠ€æœ¯ç»Ÿè®¡ç­‰ï¼‰"
            value="{{summary}}"
            bindinput="onSummaryInput"
            maxlength="1000"
            auto-height
            show-confirm-bar="{{false}}"
          />
          <view class="summary-counter">{{summary.length}}/1000</view>
        </view>
      </view>

      <!-- ç…§ç‰‡ä¸Šä¼  -->
      <view class="section-card">
        <view class="section-header">
          <text class="section-title">æ¯”èµ›ç…§ç‰‡</text>
          <text class="photo-count">{{photos.length}}/{{maxPhotos}}</text>
        </view>

        <view class="photo-grid">
          <view class="photo-item {{item.uploading ? 'uploading' : ''}}" wx:for="{{photos}}" wx:key="id">
            <image class="photo-img" src="{{item.url}}" mode="aspectFill" bindtap="onPreviewPhoto" data-index="{{index}}"></image>
            <image class="photo-delete" wx:if="{{!item.uploading}}" src="{{icons.closeRed}}" mode="aspectFit" bindtap="onDeletePhoto" data-index="{{index}}"></image>
            <view class="photo-loading" wx:if="{{item.uploading}}">
              <text class="loading-text">ä¸Šä¼ ä¸­...</text>
            </view>
          </view>

          <view class="photo-upload-btn" wx:if="{{photos.length < maxPhotos}}" bindtap="onChoosePhoto">
            <text class="upload-icon">+</text>
            <text class="upload-text">æ·»åŠ ç…§ç‰‡</text>
          </view>
        </view>
      </view>
    </view>

    <!-- åº•éƒ¨å ä½ -->
    <view class="bottom-space"></view>
  </scroll-view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="action-bar">
    <button
      class="prev-btn"
      wx:if="{{currentStep > 1}}"
      bindtap="onPrevStep"
    >
      ä¸Šä¸€æ­¥
    </button>

    <button
      class="next-btn {{currentStep === 1 ? 'full-width' : ''}}"
      wx:if="{{(currentStep < 7 && !needPenalty) || (currentStep < 8 && needPenalty)}}"
      bindtap="onNextStep"
    >
      ä¸‹ä¸€æ­¥
    </button>

    <button
      class="submit-btn full-width"
      wx:if="{{(currentStep === 7 && !needPenalty) || (currentStep === 8 && needPenalty)}}"
      bindtap="onSubmit"
      disabled="{{isSubmitting}}"
    >
      {{isSubmitting ? 'æäº¤ä¸­...' : 'æäº¤è®°å½•'}}
    </button>
  </view>
</view>

<!-- åˆ°åœºäººå‘˜é€‰æ‹©å™¨ï¼ˆåˆ†ç»„æ¨¡å¼ï¼‰ -->
<select-grid
  show="{{showParticipantPicker}}"
  title="é€‰æ‹©åˆ°åœºäººå‘˜"
  use-groups="{{true}}"
  groups="{{currentPickerTeam === 'team1' ? team1PlayerGroups : team2PlayerGroups}}"
  value="{{currentPickerTeam === 'team1' ? participantIds.team1 : participantIds.team2}}"
  multiple="{{true}}"
  display-field="name"
  value-field="id"
  show-avatar="{{true}}"
  avatar-field="avatar"
  columns="3"
  bind:confirm="onConfirmParticipants"
  bind:close="onCloseParticipantPicker"
/>

<!-- MVPé€‰æ‹©å™¨ï¼ˆåˆ†ç»„æ¨¡å¼ï¼‰ -->
<select-grid
  show="{{showMvpPicker}}"
  title="é€‰æ‹©MVP"
  use-groups="{{true}}"
  groups="{{allPlayerGroups}}"
  value="{{mvpUserIds}}"
  multiple="{{true}}"
  display-field="name"
  value-field="id"
  show-avatar="{{true}}"
  avatar-field="avatar"
  columns="3"
  empty-text="æš‚æ— çƒå‘˜"
  bind:confirm="onConfirmMvp"
  bind:close="onCloseMvpPicker"
/>
