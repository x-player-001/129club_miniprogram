<!-- 用户信息完善页面 -->
<view class="profile-edit-container">
  <!-- 自定义导航栏 -->
  <view class="custom-navbar" style="height: {{navBarHeight}}px;">
    <!-- 状态栏占位 -->
    <view class="status-bar" style="height: {{statusBarHeight}}px;"></view>
    <!-- 导航栏内容 -->
    <view class="navbar-inner">
      <view class="navbar-left" wx:if="{{type !== 'complete'}}" bindtap="onBack">
        <image class="back-icon" src="{{icons.back}}" mode="aspectFit"></image>
      </view>
      <view class="navbar-title">{{type === 'complete' ? '完善信息' : '编辑资料'}}</view>
      <view class="navbar-right"></view>
    </view>
  </view>

  <!-- 内容区域 -->
  <scroll-view class="content" scroll-y style="padding-top: {{navBarHeight}}px; height: calc(100vh - {{navBarHeight}}px);">
    <!-- 头像上传 -->
    <view class="avatar-section">
      <view class="section-label">头像</view>
      <button class="avatar-upload-btn" open-type="chooseAvatar" bindchooseavatar="onChooseAvatar">
        <!-- 已上传头像 -->
        <image wx:if="{{formData.avatar}}" class="avatar" src="{{formData.avatar}}" mode="aspectFill"></image>

        <!-- 未上传头像 - 显示上传提示 -->
        <view wx:else class="avatar-placeholder">
          <image class="camera-icon-large" src="{{icons.camera}}" mode="aspectFit"></image>
          <text class="upload-hint">点击上传</text>
        </view>

        <!-- 已上传头像时的遮罩层 -->
        <view wx:if="{{formData.avatar}}" class="avatar-mask">
          <image class="camera-icon" src="{{icons.camera}}" mode="aspectFit"></image>
          <text>点击修改</text>
        </view>
      </button>
    </view>

    <!-- 表单区域 -->
    <view class="form-section">
      <!-- 昵称（使用 type="nickname" 获取微信昵称） -->
      <view class="form-item required">
        <view class="item-label">昵称</view>
        <input
          class="item-input"
          type="nickname"
          placeholder="请输入昵称"
          value="{{formData.nickname}}"
          bindinput="onInputChange"
          bindblur="onNicknameBlur"
          data-field="nickname"
          maxlength="20"
        />
      </view>

      <!-- 姓名 -->
      <view class="form-item required">
        <view class="item-label">姓名</view>
        <input
          class="item-input"
          type="text"
          placeholder="请输入姓名"
          value="{{formData.realName}}"
          bindinput="onInputChange"
          data-field="realName"
          maxlength="20"
        />
      </view>

      <!-- 球衣号码 -->
      <view class="form-item required">
        <view class="item-label">球衣号码</view>
        <input
          class="item-input"
          type="number"
          placeholder="请输入球衣号码"
          value="{{formData.jerseyNumber}}"
          bindinput="onInputChange"
          data-field="jerseyNumber"
          maxlength="2"
        />
      </view>

      <!-- 位置选择 -->
      <view class="form-item required" bindtap="onShowPositionPicker">
        <view class="item-label">场上位置</view>
        <view class="item-picker {{formData.position ? '' : 'placeholder'}}">
          <text>{{formData.position || '请选择场上位置'}}</text>
          <image class="arrow-icon" src="{{icons.arrowRight}}" mode="aspectFit"></image>
        </view>
      </view>

      <!-- 惯用脚熟练度 -->
      <view class="form-item foot-skill-item required">
        <view class="item-label">惯用脚</view>
        <view class="foot-skill-container">
          <!-- 左脚 -->
          <view class="foot-section">
            <!-- 加减控制（横向布局：减号 - 脚印+数字 - 加号） -->
            <view class="level-control">
              <view class="control-btn minus" bindtap="onDecreaseLeftFoot">－</view>
              <view class="footprint-wrapper">
                <image
                  class="footprint-image left-foot"
                  src="{{leftFootIcon}}"
                  mode="aspectFit">
                </image>
                <view class="level-value">{{formData.leftFootLevel}}</view>
              </view>
              <view class="control-btn plus" bindtap="onIncreaseLeftFoot">＋</view>
            </view>
          </view>

          <!-- 右脚 -->
          <view class="foot-section">
            <!-- 加减控制（横向布局：减号 - 脚印+数字 - 加号） -->
            <view class="level-control">
              <view class="control-btn minus" bindtap="onDecreaseRightFoot">－</view>
              <view class="footprint-wrapper">
                <image
                  class="footprint-image"
                  src="{{rightFootIcon}}"
                  mode="aspectFit">
                </image>
                <view class="level-value">{{formData.rightFootLevel}}</view>
              </view>
              <view class="control-btn plus" bindtap="onIncreaseRightFoot">＋</view>
            </view>
          </view>
        </view>
      </view>

    </view>

    <!-- 占位空间（为底部固定按钮留出空间） -->
    <view class="bottom-space"></view>
  </scroll-view>

  <!-- 固定在底部的提交按钮 -->
  <view class="submit-section-fixed">
    <view class="submit-btn" bindtap="onSubmit" hover-class="submit-btn-hover">
      {{type === 'complete' ? '完成' : '保存'}}
    </view>
  </view>

  <!-- WXS 辅助函数 -->
  <wxs module="tools">
    var isSelected = function(arr, code) {
      for (var i = 0; i < arr.length; i++) {
        if (arr[i] === code) {
          return true;
        }
      }
      return false;
    };

    module.exports = {
      isSelected: isSelected
    };
  </wxs>

  <!-- 位置选择器弹出层 -->
  <view class="position-picker-modal {{showPositionPicker ? 'show' : ''}}" catchtap="onClosePositionPicker">
    <view class="position-picker-content" catchtap="onStopPropagation">
      <!-- 标题 -->
      <view class="picker-header">
        <text class="picker-title">选择场上位置（可多选）</text>
        <view class="close-btn" catchtap="onClosePositionPicker">
          <image src="{{icons.close}}" mode="aspectFit"></image>
        </view>
      </view>

      <!-- 位置分组 -->
      <scroll-view class="picker-body" scroll-y>
        <!-- 守门员 -->
        <view class="position-group" wx:if="{{positionGroups.GK && positionGroups.GK.length > 0}}">
          <view class="group-title">守门员 (GK)</view>
          <view class="position-tags">
            <view
              class="position-tag {{tools.isSelected(selectedPositions, item.code) ? 'selected' : ''}}"
              wx:for="{{positionGroups.GK}}"
              wx:key="id"
              data-code="{{item.code}}"
              bindtap="onTogglePosition">
              <text>{{item.name}}</text>
            </view>
          </view>
        </view>

        <!-- 后卫 -->
        <view class="position-group" wx:if="{{positionGroups.DF && positionGroups.DF.length > 0}}">
          <view class="group-title">后卫 (DF)</view>
          <view class="position-tags">
            <view
              class="position-tag {{tools.isSelected(selectedPositions, item.code) ? 'selected' : ''}}"
              wx:for="{{positionGroups.DF}}"
              wx:key="id"
              data-code="{{item.code}}"
              bindtap="onTogglePosition">
              <text>{{item.name}}</text>
            </view>
          </view>
        </view>

        <!-- 中场 -->
        <view class="position-group" wx:if="{{positionGroups.MF && positionGroups.MF.length > 0}}">
          <view class="group-title">中场 (MF)</view>
          <view class="position-tags">
            <view
              class="position-tag {{tools.isSelected(selectedPositions, item.code) ? 'selected' : ''}}"
              wx:for="{{positionGroups.MF}}"
              wx:key="id"
              data-code="{{item.code}}"
              bindtap="onTogglePosition">
              <text>{{item.name}}</text>
            </view>
          </view>
        </view>

        <!-- 前锋 -->
        <view class="position-group" wx:if="{{positionGroups.FW && positionGroups.FW.length > 0}}">
          <view class="group-title">前锋 (FW)</view>
          <view class="position-tags">
            <view
              class="position-tag {{tools.isSelected(selectedPositions, item.code) ? 'selected' : ''}}"
              wx:for="{{positionGroups.FW}}"
              wx:key="id"
              data-code="{{item.code}}"
              bindtap="onTogglePosition">
              <text>{{item.name}}</text>
            </view>
          </view>
        </view>
      </scroll-view>

      <!-- 底部按钮 -->
      <view class="picker-footer">
        <button class="cancel-btn" bindtap="onClosePositionPicker">取消</button>
        <button class="confirm-btn" bindtap="onConfirmPosition">确定</button>
      </view>
    </view>
  </view>
</view>
