# 比赛记录页面重构说明

## 📅 重构日期
2025-10-17

## 🎯 重构目标
将比赛记录页面从传统全场录入改造为支持4节制的分步录入系统。

---

## ✨ 主要变更

### 1. 数据结构升级

#### 旧版本（全场制）
```javascript
{
  team1Score: 5,
  team2Score: 3,
  events: [...]  // 所有事件平铺
}
```

#### 新版本（4节制）
```javascript
{
  quarterSystem: true,
  quarters: [
    {
      quarterNumber: 1,
      team1Goals: 3,
      team2Goals: 2,
      team1Points: 1,  // 自动计算：1-2节胜者得1分
      team2Points: 0,
      summary: '第一节...',
      events: [...]     // 该节事件
    },
    // 第2-4节...
  ],
  totalTeam1Score: 3,   // 累计得分
  totalTeam2Score: 0,
  totalTeam1Goals: 8,   // 累计进球
  totalTeam2Goals: 5
}
```

### 2. UI重构 - 分步流程

#### 7步录入流程
1. **Step 1: 基本信息** - 比赛信息确认 + 4节制开关
2. **Step 2-5: 第1-4节录入** - 使用 `quarter-input` 组件
3. **Step 6: 到场人员** - 使用 `select-grid` 组件多选
4. **Step 7: MVP与照片** - 最终确认

#### 进度指示器
- 顶部固定展示当前进度
- 7个步骤清晰可视
- 当前步骤高亮显示

### 3. 新增组件

#### `quarter-input` 组件
**位置**: `components/quarter-input/`

**功能**:
- 单节进球数输入
- 事件管理（进球、助攻、扑救、黄牌、红牌、换人）
- 节次总结文本输入
- 自动计算节次得分

**属性**:
```javascript
{
  quarterNumber: 1,          // 节次编号
  team1: {...},              // 队伍1信息
  team2: {...},              // 队伍2信息
  quarterData: {...},        // 节次数据
  allPlayers: [...]          // 球员列表
}
```

**事件**:
```javascript
bind:change="onQuarterChange"  // 数据变化回调
```

### 4. 计分逻辑

#### 节次得分规则
```javascript
// 第1-2节：胜者得1分
// 第3-4节：胜者得2分
// 平局：双方0分

calculateQuarterPoints(quarterNumber, team1Goals, team2Goals) {
  const pointsRule = {
    1: { win: 1, draw: 0 },
    2: { win: 1, draw: 0 },
    3: { win: 2, draw: 0 },
    4: { win: 2, draw: 0 }
  };

  if (team1Goals > team2Goals) {
    return { team1Points: rule.win, team2Points: 0 };
  } else if (team2Goals > team1Goals) {
    return { team1Points: 0, team2Points: rule.win };
  } else {
    return { team1Points: 0, team2Points: 0 };
  }
}
```

#### 最终得分计算
```javascript
// 累计各节得分
totalScore = quarter1.points + quarter2.points + quarter3.points + quarter4.points
```

### 5. 新增功能

#### 实时得分预览
- 在节次录入页面展示当前累计得分
- 可展开查看各节明细
- 区分"得分"和"进球数"

#### 到场人员管理
- 使用 `select-grid` 组件
- 支持两队分别选择
- 显示头像、姓名、球衣号码

#### MVP多选
- 可选择多名MVP
- 使用 `select-grid` 组件
- 显示选中球员名称

---

## 🔧 技术实现

### 1. 文件变更列表

#### 新增文件
```
components/quarter-input/
├── quarter-input.js      // 组件逻辑
├── quarter-input.wxml    // 组件模板
├── quarter-input.wxss    // 组件样式
└── quarter-input.json    // 组件配置
```

#### 重构文件
```
pages/match/record/
├── record.js             // ✅ 完全重构
├── record.wxml           // ✅ 完全重构
├── record.wxss           // ✅ 完全重构
└── record.json           // ✅ 注册组件
```

### 2. 组件复用

#### 使用已有组件
- `select-grid` - 到场人员选择、MVP选择

#### 新建组件
- `quarter-input` - 单节录入（可复用于其他4节制比赛）

---

## 📱 用户体验改进

### 1. 渐进式录入
- 分步引导，降低操作复杂度
- 每节独立录入，数据清晰
- 支持上一步/下一步导航

### 2. 实时反馈
- 自动计算节次得分
- 实时显示累计得分
- 数据验证提示

### 3. 视觉优化
- 进度指示器清晰
- 步骤动画过渡流畅
- 得分高亮显示胜者

---

## 🔒 保留功能

以下功能在重构中完整保留：

1. ✅ **照片上传** - 支持最多9张照片
2. ✅ **照片预览** - 点击查看大图
3. ✅ **照片删除** - 长按删除
4. ✅ **表单验证** - 0:0比分提示
5. ✅ **Mock数据** - 开发阶段使用
6. ✅ **API注释** - 真实API调用已注释保留

---

## 📊 API对接指南

### 提交数据格式

```javascript
// POST /api/match/:matchId/complete-quarters
{
  matchId: "match-uuid",
  quarterSystem: true,
  quarters: [
    {
      quarterNumber: 1,
      team1Goals: 3,
      team2Goals: 2,
      team1Points: 1,
      team2Points: 0,
      summary: "第一节精彩开局...",
      events: [
        {
          eventType: 'goal',
          minute: 5,
          teamId: 'team1-uuid',
          userId: 'player-uuid',
          assistUserId: 'assist-uuid',
          notes: '远射破门'
        }
      ]
    }
  ],
  participants: {
    team1: ['user-id-1', 'user-id-2'],
    team2: ['user-id-3', 'user-id-4']
  },
  mvpUserIds: ['user-id-1', 'user-id-5'],
  photos: ['url1', 'url2'],
  finalTeam1Score: 3,
  finalTeam2Score: 0,
  team1TotalGoals: 8,
  team2TotalGoals: 5
}
```

### API调用位置

**文件**: `pages/match/record/record.js`

**方法**: `submitRecord()` (第417-462行)

**说明**:
- 当前使用Mock延时模拟
- 真实API调用已注释（第452-462行）
- 需要取消注释并替换为真实接口

---

## 🎨 UI设计遵循规范

### 1. 颜色系统
- 主题色: `var(--theme-color)` (#f20810)
- 成功: `#27ae60`
- 警告: `#f39c12`
- 危险: `#e74c3c`

### 2. 间距规范
- 卡片间距: 24rpx
- 卡片内边距: 32rpx
- 元素间距: 16rpx
- 小间距: 12rpx

### 3. 字体规范
- 大标题: 36rpx / 700
- 标题: 32rpx / 700
- 正文: 28rpx / 600
- 小文字: 24rpx / 600
- 提示: 22rpx

### 4. 圆角规范
- 卡片: 24rpx
- 按钮: 16rpx
- 小元素: 12rpx

---

## ⚠️ 注意事项

### 1. WXML限制
- 不支持数组的 `.map()` 方法
- 球员名称列表在JS中预处理：
  ```javascript
  const playerNames = allPlayers.map(p => `${p.name} #${p.number}`);
  ```

### 2. 按钮样式
- 矩形按钮使用 `<button>`
- 保持 `line-height` 与 `height` 一致确保文字居中

### 3. 数据同步
- 节次数据变化时自动触发 `calculateTotalScore()`
- 使用 `setData` 回调确保计算顺序

---

## 🚀 后续优化建议

### 1. 功能增强
- [ ] 支持实时保存草稿（断点续录）
- [ ] 支持编辑已提交的比赛记录
- [ ] 支持AI简报解析导入

### 2. 性能优化
- [ ] 大量照片时使用懒加载
- [ ] 节次数据使用局部更新

### 3. 用户体验
- [ ] 添加步骤验证规则
- [ ] 添加离开页面前的确认提示
- [ ] 添加数据自动保存

---

## 📝 测试清单

### 功能测试
- [x] Step 1: 基本信息展示正确
- [x] Step 2-5: 节次录入正常
- [x] 节次得分自动计算正确
- [x] 累计得分实时更新
- [x] Step 6: 到场人员选择正常
- [x] Step 7: MVP选择正常
- [x] 照片上传/预览/删除正常
- [x] 表单验证提示正常
- [x] 提交流程正常

### UI测试
- [x] 进度指示器显示正确
- [x] 步骤切换动画流畅
- [x] 得分高亮显示正确
- [x] 响应式布局适配
- [x] 安全区域适配

---

**重构完成时间**: 2025-10-17
**重构人员**: Claude Code
**版本**: v2.0
**状态**: ✅ 已完成
