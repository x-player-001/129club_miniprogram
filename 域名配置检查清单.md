# 微信小程序域名配置检查清单

## 🔍 核心问题

**现象**：
- ✅ GitHub API 能访问
- ✅ 百度能访问
- ❌ www.greattrader.lol 不能访问
- ✅ 106.53.217.216（IP）能访问

**结论**：这个特定域名被微信小程序拦截了！

---

## ⚠️ 关键检查：微信公众平台域名配置

### 步骤1：登录微信公众平台

访问：https://mp.weixin.qq.com/

使用小程序管理员账号登录

### 步骤2：进入开发设置

路径：**开发** → **开发管理** → **开发设置** → **服务器域名**

### 步骤3：检查request合法域名

在 **request合法域名** 列表中，查找是否有：

```
https://www.greattrader.lol
```

**注意**：
- ✅ 必须包含 `https://`
- ✅ 如果域名有 `www`，必须完整写上
- ✅ 不能有端口号（`:443` 要去掉）
- ✅ 不能有路径（`/api` 要去掉）

### 正确格式示例：

✅ **正确**：`https://www.greattrader.lol`
❌ **错误**：`www.greattrader.lol`（缺少https://）
❌ **错误**：`https://www.greattrader.lol/api`（不能带路径）
❌ **错误**：`https://greattrader.lol`（如果实际用www，这个不行）
❌ **错误**：`https://106.53.217.216`（不能用IP）

---

## 🎯 关键点

### 为什么开发者工具勾选"不校验合法域名"还是不行？

勾选"不校验合法域名"只能绕过**域名白名单检查**，但不能绕过：
1. TLS版本检查
2. SSL证书验证
3. **微信服务器对该域名的连接测试**

如果微信服务器尝试连接你的域名时失败，即使勾选了"不校验"也会报错。

### 真机调试也失败的原因

真机会通过微信服务器中转请求（体验版和正式版都是），如果：
- 域名未在白名单中
- 或微信服务器无法连接到该域名

真机就会失败。

---

## 📋 完整检查清单

### 1. 微信公众平台配置

- [ ] 已登录 https://mp.weixin.qq.com/
- [ ] 进入：开发 → 开发管理 → 开发设置 → 服务器域名
- [ ] 在"request合法域名"中添加了：`https://www.greattrader.lol`
- [ ] 保存后等待5分钟生效
- [ ] 点击了"刷新"按钮

### 2. 域名要求

- [ ] 域名已备案（中国大陆服务器必须）
- [ ] 使用HTTPS协议
- [ ] SSL证书有效且未过期
- [ ] 支持TLS 1.2或更高版本
- [ ] 证书链完整（fullchain.pem）

### 3. 网络可达性

- [ ] 浏览器能访问 `https://www.greattrader.lol/api/user/info`（你已确认✅）
- [ ] curl能访问（你的curl失败了❌）
- [ ] 微信服务器能访问（需要测试）

---

## 🧪 测试微信服务器是否能访问你的域名

### 方法1：使用微信公众平台的接口检测工具

1. 登录 https://mp.weixin.qq.com/
2. 开发 → 开发管理 → 开发设置 → 服务器域名
3. 在添加域名时，微信会自动测试连接
4. 如果测试失败，会显示具体错误

### 方法2：查看微信公众平台是否有错误提示

如果域名已配置但仍然失败，在域名列表旁边可能会有：
- ❌ 红色感叹号
- ⚠️ 黄色警告
- ✅ 绿色对勾（正常）

点击查看详细错误信息。

---

## 🔧 解决方案

### 情况A：域名未配置

**症状**：体验版和真机调试都失败，开发者工具勾选"不校验"后正常

**解决**：在微信公众平台添加域名到request合法域名列表

### 情况B：域名已配置但微信服务器无法访问

**症状**：
- 浏览器能访问
- curl无法访问（Connection reset）
- 微信小程序无法访问

**可能原因**：
1. **服务器防火墙拦截了微信服务器的IP**
2. **CDN或负载均衡配置问题**
3. **微信服务器的网络环境与你的网络环境不同**

**解决方法**：

#### 1. 检查服务器防火墙

在服务器上运行：

```bash
# 查看防火墙规则
sudo iptables -L -n -v

# 临时允许所有HTTPS连接（测试用）
sudo iptables -I INPUT -p tcp --dport 443 -j ACCEPT
```

#### 2. 检查Nginx访问日志

```bash
sudo tail -f /var/log/nginx/access.log
```

在微信小程序发起请求时，查看是否有来自微信服务器的请求。

微信服务器IP段通常是：
- `101.226.*.*`
- `140.207.*.*`
- `103.7.*.*`

如果没有看到请求，说明微信服务器根本没连上。

#### 3. 使用第三方工具测试全球可达性

- https://www.17ce.com/ - 国内多节点测试
- https://dnschecker.org/ - 全球DNS测试

如果国内某些地区无法访问，可能是DNS或网络路由问题。

---

## 💡 临时解决方案

如果确实是微信服务器无法访问你的域名，临时方案：

### 使用CDN

1. 申请腾讯云CDN或阿里云CDN
2. 将域名接入CDN
3. CDN会提供一个新的域名，如 `xxx.cdn.com`
4. 在微信公众平台配置CDN域名

CDN通常能解决网络可达性问题。

---

## 📝 下一步

请按以下顺序检查：

### ✅ 第一步：确认域名是否在微信公众平台配置

登录 https://mp.weixin.qq.com/ 查看服务器域名配置

**如果已配置** → 进行第二步
**如果未配置** → 立即配置，等待5分钟后测试

### ✅ 第二步：测试微信是否能连到你的服务器

在服务器上运行：
```bash
sudo tail -f /var/log/nginx/access.log
```

然后在小程序中发起请求，看日志中是否有记录。

**如果有日志** → SSL握手可能失败，检查证书
**如果无日志** → 微信服务器连不上，检查防火墙

---

## 🚨 重要提示

**开发者工具勾选"不校验合法域名"只在以下情况有效**：
- ✅ 本地开发
- ❌ 真机调试（仍需配置域名）
- ❌ 体验版（仍需配置域名）
- ❌ 正式版（仍需配置域名）

所以真机调试失败，基本可以确定是域名配置或网络可达性问题！
